var a={socket:null,queueItemID:null,generatorResult:null,generatorProgress:null,generationPercentDone:0,selectedImage:null,sections:{prompt:{open:!0,elm:document.getElementById('prompt')},generation:{open:!0,elm:document.getElementById('generation')},image:{open:!0,elm:document.getElementById('image')}},schedulers:{'ddim':'ddim','ddpm':'ddpm','deis':'deis','lms':'lms','lms_k':'lms_k','pndm':'pndm','heun':'heun','heun_k':'heun_k','euler':'euler','euler_k':'euler_k','euler_a':'euler_a','kdpm_2':'kdpm_2','kdpm_2_a':'kdpm_2_a','dpmpp_2s':'dpmpp_2s','dpmpp_2s_k':'dpmpp_2s_k','dpmpp_2m':'dpmpp_2m','dpmpp_2m_k':'dpmpp_2m_k','dpmpp_2m_sde':'dpmpp_2m_sde','dpmpp_2m_sde_k':'dpmpp_2m_sde_k','dpmpp_sde':'dpmpp_sde','dpmpp_sde_k':'dpmpp_sde_k','unipc':'unipc','lcm':'lcm'},elms:{address:document.getElementById('address'),model_list:document.getElementById('model'),positive_prompt:document.getElementById('positive_prompt'),negative_prompt:document.getElementById('negative_prompt'),steps:document.getElementById('steps'),cfg_scale:document.getElementById('cfg_scale'),height:document.getElementById('height'),width:document.getElementById('width'),queue_size:document.getElementById('queue_size'),seed:document.getElementById('seed'),random:document.getElementById('random'),percentBar:document.getElementById('percent-bar'),generate:document.getElementById('generate'),cancel:document.getElementById('cancel'),clear:document.getElementById('clear'),scheduler:document.getElementById('scheduler'),output:document.getElementById('output'),error:document.getElementById('error'),gallery:document.getElementById('results-gallery'),username:document.getElementById('username'),password:document.getElementById('password')},config:{queue_id:'default',random:'true',queue_size:1,address:null,scheduler:'euler_a',model:null,steps:20,cfg_scale:7.5,height:512,width:512,seed:0,username:'',basic_auth:'',positive_prompt:'a painting of a cat',negative_prompt:'cartoon, painting, illustration, '+'(worst quality, low quality, normal quality:2), '+'too many limbs, bad anatomy'},init:function(){for(var A in this.schedulers){var b=document.createElement('option');b.value=this.schedulers[A];b.innerHTML=this.schedulers[A];this.elms.scheduler.appendChild(b)}for(var A in this.config){var b=document.getElementById(A);this.config[A]=this.getSaved(A)||this.config[A];if(b)switch(b.type) {case 'checkbox':b.checked=this.config[A]=='true';A=='random'&&(this.elms.seed.disabled=b.checked);break;default:b.value=this.config[A];break}}this.config.address&&this.refreshData();for(var A in this.sections){var c=this.sections[A];c.open=this.getSaved(A)=='true';c.elm.open=c.open}},connect:function(){var _=this.elms.address.value,B=this.elms.username.value,C=this.elms.password.value;var d=new XMLHttpRequest();d.open('GET',`${_}/api/v1/app/version`,!0);d.setRequestHeader('Authorization','Basic '+btoa(B+':'+C));d.onreadystatechange=function(){d.readyState==4&&(d.status==200?(this.refreshData(),this.elms.password.style.border='1px solid var(--ok-color)',this.config.basic_auth=btoa(B+':'+C),this.saveThis({id:'basic_auth',value:this.config.basic_auth})):(this.displayError('Invalid credentials'),this.elms.password.style.border='1px solid var(--error-color)'))}.bind(this);d.send()},displayError:function(_a){this.elms.error.innerHTML=_a;this.elms.error.style.display='block';setTimeout(()=>this.elms.error.style.display='none',5000)},refreshData:function(){this.fetchModels();this.fetchImages()},toggleDetails:function(e){var _b=this.sections[e];_b.open=!_b.open;this.saveThis({id:e,value:_b.open})},getSaved:function(D){return localStorage.getItem(D)||''},saveThis:function(e){switch(e.type) {case 'checkbox':this.config[e.id]=e.checked?'true':'false';localStorage.setItem(e.id,e.checked?'true':'false');break;default:this.config[e.id]=e.value;localStorage.setItem(e.id,e.value);break}e.id=='address'&&setTimeout(()=>this.refreshData(),1000);e.id=='random'&&(this.elms.seed.disabled=e.checked,!e.checked&&(this.saveThis({id:'queue_size',value:1}),this.elms.queue_size.value=1))},shuffleSeed:function(){this.elms.seed.value=~~Math.random()*1000000000;this.saveThis({id:'seed',value:this.elms.seed.value})},stepUp:function(e,_B){var _c=document.getElementById(_B);_c.stepUp();this.saveThis(_c)},stepDown:function(e,E){var _C=document.getElementById(E);_C.stepDown();this.saveThis(_C)},getServerAddressFromInput:function(){return this.elms.address.value},getHeaders:function(){let _A={'Content-Type':'application/json'};this.config.basic_auth&&(_A.Authorization='Basic '+this.config.basic_auth);return _A},cancelBatch:function(){this.elms.cancel.disabled=!0;this.elms.clear.disabled=!0;fetch(`${this.getServerAddressFromInput()}/api/v1/queue/${this.config.queue_id}/i/${this.queueItemID}/cancel`,{method:'PUT',headers:this.getHeaders()}).then(aA=>aA.ok&&(console.log('Generation cancelled'),this.elms.cancel.disabled=!1,this.elms.clear.disabled=!1,this.elms.percentBar.style.width='0%',this.elms.output.src=''))},clearQueue:function(){this.elms.cancel.disabled=!0;this.elms.clear.disabled=!0;fetch(`${this.getServerAddressFromInput()}/api/v1/queue/${this.config.queue_id}/clear`,{method:'PUT',headers:this.getHeaders()}).then(aB=>aB.ok&&(console.log('Queue cleared'),this.elms.percentBar.style.width='0%',this.elms.output.src=''))},enqueueBatch:function(){var aC=this.getServerAddressFromInput();this.elms.generate.disabled=!0;fetch(`${aC}/api/v1/queue/${this.config.queue_id}/enqueue_batch`,{method:'POST',headers:this.getHeaders(),body:JSON.stringify(this.initPayload())}).then(aD=>{if(aD.ok){this.elms.cancel.disabled=!1;this.elms.clear.disabled=!1;this.elms.generate.disabled=!1;return aD.json()}this.displayError(aD.statusText);this.elms.generate.disabled=!1}).then(aE=>console.log(aE)).catch(aF=>{this.displayError(aF);this.elms.generate.disabled=!1})},unselectImages:function(){var aG=document.getElementsByClassName('selected');for(let i=0;i<aG.length;i++)aG[i].classList.remove('selected')},fetchImages:function(){var aH=this.getServerAddressFromInput();fetch(`${aH}/api/v1/images/`,{credentials:'include'}).then(aI=>{if(aI.ok)return aI.json()}).then(aJ=>{this.elms.gallery.innerHTML='';for(let i=0;i<aJ.items.length;i++){var aK=document.createElement('div'),aL=aJ.items[i],_d=document.createElement('img'),_e=document.createElement('div'),f=document.createElement('button'),g=document.createElement('a');aK.classList.add('gallery-image-container');this.elms.gallery.appendChild(aK);_d.src=aH+'/'+aL.thumbnail_url;_d.classList.add('gallery-image');_d.onclick=()=>{this.unselectImages();this.selectedImage&&this.selectedImage.image_name==aL.image_name?this.selectedImage=null:this.elms.output.src=aH+'/'+aL.image_url;fetch(`${aH}/api/v1/images/i/${aL.image_name}/metadata`,{credentials:'include'}).then(aM=>{if(aM.ok)return aM.json()}).then(aN=>{var aO=document.getElementById('metadata-table');aO.innerHTML='';for(let aQ in aN){var aP=document.createElement('tr'),_D=document.createElement('td');if(this.config.hasOwnProperty(aQ)){let aR=document.createElement('button');aR.innerHTML='Load';let aS=this.elms[aQ];aR.onclick=()=>{aS.value=aN[aQ];this.saveThis({id:aQ,value:aN[aQ]})};_D.appendChild(aR)}aP.appendChild(_D);_D=document.createElement('td');_D.innerHTML=aQ;aP.appendChild(_D);_D=document.createElement('td');_D.innerHTML=JSON.stringify(aN[aQ]);aP.appendChild(_D);aO.appendChild(aP)}}).catch(aT=>this.displayError(aT))};aK.appendChild(_d);_e.classList.add('image-button-container');aK.appendChild(_e);f.classList.add('delete-button');f.innerHTML='Delete';f.onclick=()=>fetch(`${aH}/api/v1/images/i/${aL.image_name}`,{method:'DELETE',headers:this.getHeaders()}).then(aU=>aU.ok&&(this.fetchImages(),this.elms.output.src.indexOf(aL.image_url)>-1&&(this.elms.output.src='',setTimeout(()=>{let aV=this.elms.gallery.firstChild.firstChild;output.src=aV.src.replace('thumbnail','full')},1000))));g.href=aH+'/'+aL.image_url;g.target='_blank';g.innerHTML='Full Image';g.classList.add('full-image-button');_e.appendChild(g);_e.appendChild(f);!i&&this.elms.output.src.indexOf(window.location.href)>-1&&(this.elms.output.src=aH+'/'+aL.image_url)}}).catch(aW=>this.displayError(aW))},fetchModels:function(){var aX=this.getServerAddressFromInput();fetch(`${aX}/api/v1/models/`,{credentials:'include'}).then(aY=>{if(aY.ok)return aY.json()}).then(aZ=>{this.elms.model_list.innerHTML='';for(const bB of aZ.models)if(bB.model_type=='main'){var bA=document.createElement('option');bA.value=JSON.stringify(bB);bA.innerHTML=bB.model_name;this.elms.model_list.appendChild(bA);this.getSaved('model')==JSON.stringify(bB)?this.elms.model_list.value=JSON.stringify(bB):null}this.initSocket(aX)}).catch(bC=>this.displayError(bC))},initSocket:function(bD){var bE=bD.replace('http','ws');bE=bE.replace('https','wss');this.socket=io(bE,{path:'/ws/socket.io',transports:['websocket']});this.socket.on('connect',()=>{console.log('Connected to server');this.socket.emit('subscribe_queue',{queue_id:this.config.queue_id})});this.socket.on('generator_progress',bF=>{this.generatorProgress=bF.progress_image;let bG=bF.step;let bH=bF.total_steps;this.queueItemID=bF.queue_item_id;this.elms.percentBar.style.width=~~(bG/bH)*100+'%';this.elms.percentBar.style.border='1px solid var(--ok-graphical-fg)';this.elms.cancel.disabled=!1;this.elms.clear.disabled=!1;this.generationPercentDone=~~(bG/bH)*100;console.log('generator_progress',bF.step);!this.selectedImage&&(this.elms.output.src=this.generatorProgress.dataURL,this.elms.output.style.display='block')});this.socket.on('batch_enqueued',bI=>console.log('batch_enqueued',bI));this.socket.on('queue_item_status_changed',bJ=>{console.log('queue_item_status_changed',bJ);var bK=bJ.queue_status.pending,bL=document.getElementById('pending-count'),bM=document.getElementById('pending');bK>0?(this.elms.cancel.disabled=!1,this.elms.clear.disabled=!1,bL.style.backgroundColor='var(--warning-color)',bL.style.color='black'):(bL.style.backgroundColor='var(--surface-color-1)',bL.style.color='var(--text-color-1)',this.elms.cancel.disabled=!0,this.elms.clear.disabled=!0);bM.innerHTML=bK});this.socket.on('invocation_started',bN=>{var bO=parseInt(bN.node.seed);this.elms.cancel.disabled=!1;bO&&this.elms.random.checked&&(this.elms.seed.value=bO,this.saveThis({id:'seed',value:bO}))});this.socket.on('invocation_complete',bP=>{this.generatorResult=bP.result;if(this.generatorResult.image){console.log('invocation_complete',bP);this.elms.percentBar.style.width='100%';this.selectedImage=null;var bQ=bD+'/api/v1/images/i/'+this.generatorResult.image.image_name+'/full';this.elms.output.src=bQ;this.elms.output.style.display='block';this.fetchImages();setTimeout(()=>this.elms.percentBar.style.width='0%',2500)}});this.socket.on('invocation_error',bR=>{console.log('invocation_error',bR);this.displayError(bR.error_type)})},initPayload:function(){var bS=[parseInt(this.config.seed)],bT=JSON.parse(this.elms.model_list.value),bU={'queue_id':this.config.queue_id,'batch':{'data':[[{'node_path':'noise','field_name':'seed','items':bS},{'node_path':'core_metadata','field_name':'seed','items':bS}],[{'node_path':'positive_conditioning','field_name':'prompt','items':[this.config.positive_prompt]},{'node_path':'core_metadata','field_name':'positive_prompt','items':[this.config.positive_prompt]}]],'graph':{'id':'text_to_image_graph','nodes':{'main_model_loader':{'id':'main_model_loader','is_intermediate':!0,'use_cache':!0,'model':{'model_name':bT.model_name,'base_model':bT.base_model,'model_type':bT.model_type},'type':'main_model_loader'},'clip_skip':{'id':'clip_skip','is_intermediate':!0,'use_cache':!0,'skipped_layers':0,'type':'clip_skip'},'positive_conditioning':{'id':'positive_conditioning','is_intermediate':!0,'use_cache':!0,'prompt':this.config.positive_prompt,'type':'compel'},'negative_conditioning':{'id':'negative_conditioning','is_intermediate':!0,'use_cache':!0,'prompt':this.config.negative_prompt,'type':'compel'},'noise':{'id':'noise','is_intermediate':!0,'use_cache':!0,'width':this.config.width,'height':this.config.height,'seed':parseInt(this.config.seed),'use_cpu':!0,'type':'noise'},'denoise_latents':{'id':'denoise_latents','is_intermediate':!0,'use_cache':!0,'steps':this.config.steps,'cfg_scale':this.config.cfg_scale,'denoising_start':0,'denoising_end':1,'scheduler':this.config.scheduler,'cfg_rescale_multiplier':0,'type':'denoise_latents'},'latents_to_image':{'id':'latents_to_image','is_intermediate':!0,'use_cache':!1,'tiled':!1,'fp32':!0,'type':'l2i'},'core_metadata':{'id':'core_metadata','is_intermediate':!1,'use_cache':!0,'generation_mode':'txt2img','negative_prompt':this.config.negative_prompt,'width':this.config.width,'height':this.config.height,'rand_device':'cpu','cfg_scale':this.config.cfg_scale,'cfg_rescale_multiplier':0,'steps':this.config.steps,'scheduler':this.config.scheduler,'clip_skip':0,'model':{'model_name':bT.model_name,'base_model':bT.base_model,'model_type':bT.model_type},'type':'core_metadata'},'linear_ui_output':{'id':'linear_ui_output','is_intermediate':!1,'use_cache':!1,'type':'linear_ui_output'}},'edges':[{'source':{'node_id':'main_model_loader','field':'unet'},'destination':{'node_id':'denoise_latents','field':'unet'}},{'source':{'node_id':'main_model_loader','field':'clip'},'destination':{'node_id':'clip_skip','field':'clip'}},{'source':{'node_id':'clip_skip','field':'clip'},'destination':{'node_id':'positive_conditioning','field':'clip'}},{'source':{'node_id':'clip_skip','field':'clip'},'destination':{'node_id':'negative_conditioning','field':'clip'}},{'source':{'node_id':'positive_conditioning','field':'conditioning'},'destination':{'node_id':'denoise_latents','field':'positive_conditioning'}},{'source':{'node_id':'negative_conditioning','field':'conditioning'},'destination':{'node_id':'denoise_latents','field':'negative_conditioning'}},{'source':{'node_id':'noise','field':'noise'},'destination':{'node_id':'denoise_latents','field':'noise'}},{'source':{'node_id':'denoise_latents','field':'latents'},'destination':{'node_id':'latents_to_image','field':'latents'}},{'source':{'node_id':'core_metadata','field':'metadata'},'destination':{'node_id':'latents_to_image','field':'metadata'}},{'source':{'node_id':'main_model_loader','field':'vae'},'destination':{'node_id':'latents_to_image','field':'vae'}},{'source':{'node_id':'latents_to_image','field':'image'},'destination':{'node_id':'linear_ui_output','field':'image'}}]},'runs':1}};if(this.config.random=='true'){bS=[];for(var i=0;i<this.config.queue_size;i++)bS.push(~~Math.random()*1000000000)}else this.elms.queue_size.value=1;return bU}};a.init();
