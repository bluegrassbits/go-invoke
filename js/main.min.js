var a={socket:null,queueItemID:null,generatorResult:null,generatorProgress:null,generationPercentDone:0,selectedImage:null,sections:{prompt:{open:!0,elm:document.getElementById('prompt')},generation:{open:!0,elm:document.getElementById('generation')},image:{open:!0,elm:document.getElementById('image')},server:{open:!0,elm:document.getElementById('server')}},schedulers:{'ddim':'ddim','ddpm':'ddpm','deis':'deis','lms':'lms','lms_k':'lms_k','pndm':'pndm','heun':'heun','heun_k':'heun_k','euler':'euler','euler_k':'euler_k','euler_a':'euler_a','kdpm_2':'kdpm_2','kdpm_2_a':'kdpm_2_a','dpmpp_2s':'dpmpp_2s','dpmpp_2s_k':'dpmpp_2s_k','dpmpp_2m':'dpmpp_2m','dpmpp_2m_k':'dpmpp_2m_k','dpmpp_2m_sde':'dpmpp_2m_sde','dpmpp_2m_sde_k':'dpmpp_2m_sde_k','dpmpp_sde':'dpmpp_sde','dpmpp_sde_k':'dpmpp_sde_k','unipc':'unipc','lcm':'lcm'},elms:{address:document.getElementById('address'),model_list:document.getElementById('model'),positive_prompt:document.getElementById('positive_prompt'),negative_prompt:document.getElementById('negative_prompt'),steps:document.getElementById('steps'),cfg_scale:document.getElementById('cfg_scale'),height:document.getElementById('height'),width:document.getElementById('width'),queue_size:document.getElementById('queue_size'),seed:document.getElementById('seed'),random:document.getElementById('random'),percentBar:document.getElementById('percent-bar'),generate:document.getElementById('generate'),cancel:document.getElementById('cancel'),clear:document.getElementById('clear'),scheduler:document.getElementById('scheduler'),output:document.getElementById('output'),error:document.getElementById('error'),gallery:document.getElementById('results-gallery'),username:document.getElementById('username'),password:document.getElementById('password'),connect:document.getElementById('connect'),shuffle:document.getElementById('shuffle')},config:{queue_id:'default',random:'true',queue_size:1,address:null,scheduler:'euler_a',model:null,steps:20,cfg_scale:7.5,height:512,width:512,seed:0,username:'',basic_auth:'',positive_prompt:'a painting of a cat',negative_prompt:'cartoon, painting, illustration, '+'(worst quality, low quality, normal quality:2), '+'too many limbs, bad anatomy'},init:function(){for(var A in this.schedulers){var b=document.createElement('option');b.value=this.schedulers[A];b.innerHTML=this.schedulers[A];this.elms.scheduler.appendChild(b)}this.elms.connect.onclick=()=>this.connect();this.elms.shuffle.onclick=()=>this.shuffleSeed();this.elms.generate.onclick=()=>this.enqueueBatch();this.elms.cancel.onclick=()=>this.cancelBatch();this.elms.clear.onclick=()=>this.clearQueue();for(let _ in this.config){let B=document.getElementById(_);this.config[_]=this.getSaved(_)||this.config[_];console.log(_,this.config[_]);if(B)switch(B.type) {case 'text':B.value=this.config[_];B.onkeyup=()=>this.saveThis({id:_,value:B.value});break;case 'textarea':B.value=this.config[_];B.onkeyup=()=>this.saveThis({id:_,value:B.value});break;case 'checkbox':B.checked=this.config[_]=='true';_=='random'&&(this.elms.seed.disabled=B.checked);B.onchange=()=>{this.saveThis({id:_,value:B.checked});_=='random'&&(this.elms.seed.disabled=B.checked)};break;default:B.value=this.config[_];B.onchange=()=>this.saveThis({id:_,value:B.value});break}}this.config.address&&this.refreshData();for(let C in this.sections){let _a=this.sections[C];_a.open=this.getSaved(C)=='true';_a.elm.open=_a.open;let _b=_a.elm.querySelector('summary');_b.onclick=()=>this.toggleDetails(C)}let c=document.querySelectorAll('.spinner-button');for(let d of c){let D=d.getAttribute('data-target');let _B=d.getAttribute('data-action');d.onclick=()=>_B=='increment'?this.stepUp(d,D):_B=='decrement'&&this.stepDown(d,D)}},connect:function(){var _A=this.elms.address.value,E=this.elms.username.value,_c=this.elms.password.value;var _d=new XMLHttpRequest();_d.open('GET',`${_A}/api/v1/app/version`,!0);_d.setRequestHeader('Authorization','Basic '+btoa(E+':'+_c));_d.onreadystatechange=function(){_d.readyState==4&&(_d.status==200?(this.refreshData(),this.elms.password.style.border='1px solid var(--ok-color)',this.config.basic_auth=btoa(E+':'+_c),this.saveThis({id:'basic_auth',value:this.config.basic_auth})):(this.displayError('Invalid credentials'),this.elms.password.style.border='1px solid var(--error-color)'))}.bind(this);_d.send()},displayError:function(aA){this.elms.error.innerHTML=aA;this.elms.error.style.display='block';setTimeout(()=>this.elms.error.style.display='none',5000)},refreshData:function(){this.fetchModels();this.fetchImages()},toggleDetails:function(e){var aB=this.sections[e];aB.open=!aB.open;this.saveThis({id:e,value:aB.open})},getSaved:function(aC){return localStorage.getItem(aC)||''},saveThis:function(e){switch(e.type) {case 'checkbox':this.config[e.id]=e.checked?'true':'false';localStorage.setItem(e.id,e.checked?'true':'false');break;default:this.config[e.id]=e.value;localStorage.setItem(e.id,e.value);break}e.id=='address'&&setTimeout(()=>this.refreshData(),1000);e.id=='random'&&(this.elms.seed.disabled=e.checked,!e.checked&&(this.saveThis({id:'queue_size',value:1}),this.elms.queue_size.value=1))},shuffleSeed:function(){this.elms.seed.value=~~Math.random()*1000000000;this.saveThis({id:'seed',value:this.elms.seed.value})},stepUp:function(e,aD){var _C=document.getElementById(aD);_C.stepUp();this.saveThis(_C)},stepDown:function(e,aE){var aF=document.getElementById(aE);aF.stepDown();this.saveThis(aF)},getServerAddressFromInput:function(){return this.elms.address.value},getHeaders:function(){let aG={'Content-Type':'application/json'};this.config.basic_auth&&(aG.Authorization='Basic '+this.config.basic_auth);return aG},cancelBatch:function(){this.elms.cancel.disabled=!0;this.elms.clear.disabled=!0;fetch(`${this.getServerAddressFromInput()}/api/v1/queue/${this.config.queue_id}/i/${this.queueItemID}/cancel`,{method:'PUT',headers:this.getHeaders()}).then(aH=>aH.ok&&(console.log('Generation cancelled'),this.elms.cancel.disabled=!1,this.elms.clear.disabled=!1,this.elms.percentBar.style.width='0%',this.elms.output.src=''))},clearQueue:function(){this.elms.cancel.disabled=!0;this.elms.clear.disabled=!0;fetch(`${this.getServerAddressFromInput()}/api/v1/queue/${this.config.queue_id}/clear`,{method:'PUT',headers:this.getHeaders()}).then(aI=>aI.ok&&(console.log('Queue cleared'),this.elms.percentBar.style.width='0%',this.elms.output.src=''))},enqueueBatch:function(){var aJ=this.getServerAddressFromInput();this.elms.generate.disabled=!0;fetch(`${aJ}/api/v1/queue/${this.config.queue_id}/enqueue_batch`,{method:'POST',headers:this.getHeaders(),body:JSON.stringify(this.initPayload())}).then(aK=>{if(aK.ok){this.elms.cancel.disabled=!1;this.elms.clear.disabled=!1;this.elms.generate.disabled=!1;return aK.json()}this.displayError(aK.statusText);this.elms.generate.disabled=!1}).then(aL=>console.log(aL)).catch(aM=>{this.displayError(aM);this.elms.generate.disabled=!1})},unselectImages:function(){var aN=document.getElementsByClassName('selected');for(let i=0;i<aN.length;i++)aN[i].classList.remove('selected')},fetchImages:function(){var aO=this.getServerAddressFromInput();fetch(`${aO}/api/v1/images/`,{credentials:'include'}).then(aP=>{if(aP.ok)return aP.json()}).then(aQ=>{this.elms.gallery.innerHTML='';for(let i=0;i<aQ.items.length;i++){var aR=document.createElement('div'),aS=aQ.items[i],_D=document.createElement('img'),_e=document.createElement('div'),f=document.createElement('button'),g=document.createElement('a');aR.classList.add('gallery-image-container');this.elms.gallery.appendChild(aR);_D.src=aO+'/'+aS.thumbnail_url;_D.classList.add('gallery-image');_D.onclick=()=>{this.unselectImages();this.selectedImage&&this.selectedImage.image_name==aS.image_name?this.selectedImage=null:this.elms.output.src=aO+'/'+aS.image_url;fetch(`${aO}/api/v1/images/i/${aS.image_name}/metadata`,{credentials:'include'}).then(aT=>{if(aT.ok)return aT.json()}).then(aU=>{var aV=document.getElementById('metadata-table');aV.innerHTML='';for(let aY in aU){var aW=document.createElement('tr'),aX=document.createElement('td');if(this.config.hasOwnProperty(aY)){let aZ=document.createElement('button');aZ.innerHTML='Load';let bA=this.elms[aY];aZ.onclick=()=>{bA.value=aU[aY];this.saveThis({id:aY,value:aU[aY]})};aX.appendChild(aZ)}aW.appendChild(aX);aX=document.createElement('td');aX.innerHTML=aY;aW.appendChild(aX);aX=document.createElement('td');aX.innerHTML=JSON.stringify(aU[aY]);aW.appendChild(aX);aV.appendChild(aW)}}).catch(bB=>this.displayError(bB))};aR.appendChild(_D);_e.classList.add('image-button-container');aR.appendChild(_e);f.classList.add('delete-button');f.innerHTML='Delete';f.onclick=()=>fetch(`${aO}/api/v1/images/i/${aS.image_name}`,{method:'DELETE',headers:this.getHeaders()}).then(bC=>bC.ok&&(this.fetchImages(),this.elms.output.src.indexOf(aS.image_url)>-1&&(this.elms.output.src='',setTimeout(()=>{let bD=this.elms.gallery.firstChild.firstChild;output.src=bD.src.replace('thumbnail','full')},1000))));g.href=aO+'/'+aS.image_url;g.target='_blank';g.innerHTML='Full Image';g.classList.add('full-image-button');_e.appendChild(g);_e.appendChild(f);!i&&this.elms.output.src.indexOf(window.location.href)>-1&&(this.elms.output.src=aO+'/'+aS.image_url)}}).catch(bE=>this.displayError(bE))},fetchModels:function(){var bF=this.getServerAddressFromInput();fetch(`${bF}/api/v1/models/`,{credentials:'include'}).then(bG=>{if(bG.ok)return bG.json()}).then(bH=>{this.elms.model_list.innerHTML='';for(const bJ of bH.models)if(bJ.model_type=='main'){var bI=document.createElement('option');bI.value=JSON.stringify(bJ);bI.innerHTML=bJ.model_name;this.elms.model_list.appendChild(bI);this.getSaved('model')==JSON.stringify(bJ)?this.elms.model_list.value=JSON.stringify(bJ):null}this.initSocket(bF)}).catch(bK=>this.displayError(bK))},initSocket:function(bL){var bM=bL.replace('http','ws');bM=bM.replace('https','wss');this.socket=io(bM,{path:'/ws/socket.io',transports:['websocket']});this.socket.on('connect',()=>{console.log('Connected to server');this.socket.emit('subscribe_queue',{queue_id:this.config.queue_id})});this.socket.on('generator_progress',bN=>{this.generatorProgress=bN.progress_image;let bO=bN.step;let bP=bN.total_steps;this.queueItemID=bN.queue_item_id;this.elms.percentBar.style.width=~~(bO/bP)*100+'%';this.elms.percentBar.style.border='1px solid var(--ok-graphical-fg)';this.elms.cancel.disabled=!1;this.elms.clear.disabled=!1;this.generationPercentDone=~~(bO/bP)*100;console.log('generator_progress',bN.step);!this.selectedImage&&(this.elms.output.src=this.generatorProgress.dataURL,this.elms.output.style.display='block')});this.socket.on('batch_enqueued',bQ=>console.log('batch_enqueued',bQ));this.socket.on('queue_item_status_changed',bR=>{console.log('queue_item_status_changed',bR);var bS=bR.queue_status.pending,bT=document.getElementById('pending-count'),bU=document.getElementById('pending');bS>0?(this.elms.cancel.disabled=!1,this.elms.clear.disabled=!1,bT.style.backgroundColor='var(--warning-color)',bT.style.color='black'):(bT.style.backgroundColor='var(--surface-color-1)',bT.style.color='var(--text-color-1)',this.elms.cancel.disabled=!0,this.elms.clear.disabled=!0);bU.innerHTML=bS});this.socket.on('invocation_started',bV=>{var bW=parseInt(bV.node.seed);this.elms.cancel.disabled=!1;bW&&this.elms.random.checked&&(this.elms.seed.value=bW,this.saveThis({id:'seed',value:bW}))});this.socket.on('invocation_complete',bX=>{this.generatorResult=bX.result;if(this.generatorResult.image){console.log('invocation_complete',bX);this.elms.percentBar.style.width='100%';this.selectedImage=null;var bY=bL+'/api/v1/images/i/'+this.generatorResult.image.image_name+'/full';this.elms.output.src=bY;this.elms.output.style.display='block';this.fetchImages();setTimeout(()=>this.elms.percentBar.style.width='0%',2500)}});this.socket.on('invocation_error',bZ=>{console.log('invocation_error',bZ);this.displayError(bZ.error_type)})},initPayload:function(){var cA=[parseInt(this.config.seed)],cB=JSON.parse(this.elms.model_list.value),cC={'queue_id':this.config.queue_id,'batch':{'data':[[{'node_path':'noise','field_name':'seed','items':cA},{'node_path':'core_metadata','field_name':'seed','items':cA}],[{'node_path':'positive_conditioning','field_name':'prompt','items':[this.config.positive_prompt]},{'node_path':'core_metadata','field_name':'positive_prompt','items':[this.config.positive_prompt]}]],'graph':{'id':'text_to_image_graph','nodes':{'main_model_loader':{'id':'main_model_loader','is_intermediate':!0,'use_cache':!0,'model':{'model_name':cB.model_name,'base_model':cB.base_model,'model_type':cB.model_type},'type':'main_model_loader'},'clip_skip':{'id':'clip_skip','is_intermediate':!0,'use_cache':!0,'skipped_layers':0,'type':'clip_skip'},'positive_conditioning':{'id':'positive_conditioning','is_intermediate':!0,'use_cache':!0,'prompt':this.config.positive_prompt,'type':'compel'},'negative_conditioning':{'id':'negative_conditioning','is_intermediate':!0,'use_cache':!0,'prompt':this.config.negative_prompt,'type':'compel'},'noise':{'id':'noise','is_intermediate':!0,'use_cache':!0,'width':this.config.width,'height':this.config.height,'seed':parseInt(this.config.seed),'use_cpu':!0,'type':'noise'},'denoise_latents':{'id':'denoise_latents','is_intermediate':!0,'use_cache':!0,'steps':this.config.steps,'cfg_scale':this.config.cfg_scale,'denoising_start':0,'denoising_end':1,'scheduler':this.config.scheduler,'cfg_rescale_multiplier':0,'type':'denoise_latents'},'latents_to_image':{'id':'latents_to_image','is_intermediate':!0,'use_cache':!1,'tiled':!1,'fp32':!0,'type':'l2i'},'core_metadata':{'id':'core_metadata','is_intermediate':!1,'use_cache':!0,'generation_mode':'txt2img','negative_prompt':this.config.negative_prompt,'width':this.config.width,'height':this.config.height,'rand_device':'cpu','cfg_scale':this.config.cfg_scale,'cfg_rescale_multiplier':0,'steps':this.config.steps,'scheduler':this.config.scheduler,'clip_skip':0,'model':{'model_name':cB.model_name,'base_model':cB.base_model,'model_type':cB.model_type},'type':'core_metadata'},'linear_ui_output':{'id':'linear_ui_output','is_intermediate':!1,'use_cache':!1,'type':'linear_ui_output'}},'edges':[{'source':{'node_id':'main_model_loader','field':'unet'},'destination':{'node_id':'denoise_latents','field':'unet'}},{'source':{'node_id':'main_model_loader','field':'clip'},'destination':{'node_id':'clip_skip','field':'clip'}},{'source':{'node_id':'clip_skip','field':'clip'},'destination':{'node_id':'positive_conditioning','field':'clip'}},{'source':{'node_id':'clip_skip','field':'clip'},'destination':{'node_id':'negative_conditioning','field':'clip'}},{'source':{'node_id':'positive_conditioning','field':'conditioning'},'destination':{'node_id':'denoise_latents','field':'positive_conditioning'}},{'source':{'node_id':'negative_conditioning','field':'conditioning'},'destination':{'node_id':'denoise_latents','field':'negative_conditioning'}},{'source':{'node_id':'noise','field':'noise'},'destination':{'node_id':'denoise_latents','field':'noise'}},{'source':{'node_id':'denoise_latents','field':'latents'},'destination':{'node_id':'latents_to_image','field':'latents'}},{'source':{'node_id':'core_metadata','field':'metadata'},'destination':{'node_id':'latents_to_image','field':'metadata'}},{'source':{'node_id':'main_model_loader','field':'vae'},'destination':{'node_id':'latents_to_image','field':'vae'}},{'source':{'node_id':'latents_to_image','field':'image'},'destination':{'node_id':'linear_ui_output','field':'image'}}]},'runs':1}};if(this.config.random=='true'){cA=[];for(var i=0;i<this.config.queue_size;i++)cA.push(~~Math.random()*1000000000)}else this.elms.queue_size.value=1;return cC}};a.init();
